
# Engineering Rules (Agents)

## Как запускать
- **MUST:** Установка зависимостей через `pnpm install`.
- **MUST:** Генерировать Prisma Client через `pnpm prisma generate` после изменений схемы.
- **MUST:** Для dev-миграций использовать `pnpm prisma migrate dev --name "<msg>"`.
- **SHOULD:** Локальный запуск через `pnpm dev`.
- **SHOULD:** Запуск тестов через `pnpm test`.

## Контроль качества (Definition of Done)
- **MUST:** После завершения задачи запускать:
  - `pnpm exec tsc --noEmit`
  - `pnpm lint`
- **SHOULD:** Запускать `pnpm build`, особенно при изменениях:
  - RSC boundaries,
  - Server Actions,
  - архитектуры страниц/клиентских компонентов.

## UI / Design System
- **SHOULD:** Использовать `shadcn/ui` для новых элементов интерфейса.
- **MUST:** Использовать `Tailwind` совместно с `shadcn/ui`.
- **MUST NOT:** Не менять глобальные токены темы без отдельной задачи.

## Правила кода
- **MUST:** TypeScript `strict`, `ESM`.
- **MUST:** Формы реализовывать на `React + RHF + Zod`.
- **MUST:** Валидацию держать в `Zod`-схемах.
- **SHOULD:** Выносить тяжёлую бизнес-логику из компонентов в хуки/сервисы.
- **MUST NOT:** Не дублировать бизнес-логику в нескольких UI-слоях без общего источника.

## Server Actions
- **MUST:** Хранить server actions только в `app/actions/*.ts`.
- **MUST:** Ставить `'use server'` на уровне файла в `app/actions/*`.
- **MUST NOT:** Не объявлять server actions в `page.tsx`/UI-компонентах, если они будут использоваться клиентом.
- **SHOULD:** Следовать композиции:
  - `page.tsx` (Server) → `*Client.tsx` (Client UI) → `app/actions/*` (Server Actions).

## Границы Server/Client (RSC)
- **MUST:** В Client Components передавать пропсами только:
  - сериализуемые данные,
  - server actions.
- **MUST NOT:** Не передавать обычные функции/хелперы в Client Components через props.
- **MUST:** Проверки прав, доступ к БД, работу с сессией выполнять на сервере.
- **MUST:** В client передавать результаты вычислений, а не функции вычислений.
- **MUST NOT:** Не импортировать серверные модули (`auth/db/prisma/role-check`) в файлы с `'use client'`.

## i18n
- **MUST:** Использовать `next-intl` (App Router).
- **MUST:** Поддерживать `ru` (default), `uk`, `en`.
- **MUST:** Все пользовательские строки выводить только через `t()`.
- **MUST NOT:** Не допускать хардкода пользовательских строк.
- **SHOULD:** Даты/валюты форматировать через `useFormatter()`.
- **MUST:** Сообщения валидации (Zod/RHF) брать из i18n.
- **MUST:** Источник правды — `messages/en/*.json`, затем синхронизировать `uk/ru`.

## State management: Zustand
- **MUST:** Организовывать сторы по доменным “слайсам” в `src/stores/*`.
- **MUST:** Обновлять состояние только через экшены (`set()`/immer).
- **MUST NOT:** Не мутировать состояние вне `set()`/immer.
- **SHOULD:** Держать сложную бизнес-логику в сервисах/хелперах.
- **MUST:** Использовать `persist` только для сериализуемых данных.
- **MUST NOT:** Не сохранять в `persist` функции/классы/`Date` без явной сериализации.
- **SHOULD:** В компонентах использовать селекторы + `shallow`.
- **MUST:** У каждого стора должен быть `reset()`.

## Prisma / DB
- **MUST:** После изменений `schema.prisma`:
  - обновить миграции,
  - при необходимости обновить `seed`,
  - проверить зависимые формы/валидации.
- **SHOULD:** Держать бизнес-правила расчётов в одном серверном месте (service/helper).

## Безопасность
- **MUST NOT:** Не коммитить `.env*`.
- **MUST:** Секреты хранить только в настройках окружения.
- **MUST:** При изменениях в NextAuth:
  - проверять схемы,
  - seed,
  - логику ролей и доступов.
- **MUST NOT:** Не менять провайдеры/стратегии без соответствующих обновлений.

## Anti-patterns
- **MUST NOT:** Не объявлять server actions внутри `page.tsx`, если их должен вызывать клиент.
- **MUST NOT:** Не использовать `'use server'` внутри отдельных функций вместо директивы на уровне файла.
- **MUST NOT:** Не передавать обычные функции в Client Components.
- **MUST NOT:** Не импортировать `auth/db/prisma` в `'use client'` файлы.
- **MUST NOT:** Не хардкодить пользовательские строки и тексты ошибок валидации.
- **MUST NOT:** Не хранить несериализуемые данные в Zustand `persist`.
